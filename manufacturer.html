<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Manufacturer Portal - Certificate Management</title>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css" />

  <style>
    :root { --field-height: 45px; --field-gap: 10px; }

    body {
      font-family: "Segoe UI", Arial, sans-serif;
      margin: 0;
      padding: 30px;
      background: linear-gradient(135deg, #0a0a0a, #1a1a2e);
      color: #e0e0e0; min-height: 100vh;
    }
    
    /* Navigation buttons styling */
    .nav-container {
      display: flex;
      justify-content: center;
      gap: 15px;
      margin: 15px 0;
      flex-wrap: wrap;
    }
    
    .nav-button {
      background: linear-gradient(135deg, #00d4ff, #0096c7);
      color: #000;
      border: none;
      border-radius: 5px;
      padding: 10px 15px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s ease;
      box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
      text-decoration: none;
    }
    
    .nav-button:hover {
      transform: translateY(-3px);
      box-shadow: 0 6px 8px rgba(0, 0, 0, 0.2);
      background: linear-gradient(135deg, #00e5ff, #00a8e8);
    }
    
    .nav-button:active {
      transform: translateY(1px);
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
    }
    .container {
      max-width: 1200px; margin: 0 auto;
      background: linear-gradient(145deg, #1e1e1e, #2a2a2a);
      padding: 35px; border-radius: 14px;
      box-shadow: 0 8px 25px rgba(0,0,0,.5); animation: fadeIn .9s ease-out;
    }
    h1 {
      text-align: center; font-size: 2.2rem; font-weight: 700; margin-bottom: 25px; color: #fff;
      border-bottom: 4px solid #ff6b9d; display: inline-block; padding-bottom: 6px; width: 100%;
    }
    .network-info {
      background: linear-gradient(135deg, #2a2a3e, #1a1a2e);
      border: 1px solid #00d4ff; padding: 15px; border-radius: 8px; margin-bottom: 25px;
      font-size: .95rem; animation: slideIn .7s ease; color: #b0e0ff;
    }
    .section {
      background: linear-gradient(145deg, #2e2535, #3a2f3f); border: 1px solid #ff6b9d;
      padding: 25px; border-radius: 12px; margin-bottom: 25px;
      box-shadow: 0 4px 15px rgba(255,107,157,.1);
      transition: transform .3s ease, box-shadow .3s ease; animation: fadeInUp .8s ease;
    }
    .section:hover { transform: translateY(-4px); box-shadow: 0 6px 20px rgba(255,107,157,.2); }
    h2 { margin-top: 0; font-size: 1.4rem; border-left: 4px solid #ff6b9d; padding-left: 10px; margin-bottom: 15px; color: #fff; }
    h3 { color: #fff; font-size: 1.1rem; margin-bottom: 10px; }
    h4 { color: #ff6b9d; font-size: 1rem; margin-bottom: 8px; }

    label { display: block; color: #00ff88; font-weight: 600; margin-bottom: 5px; font-size: .9rem; }
    .muted { color:#b0b0b0; font-size:.85rem; }

    input[type="text"], select, textarea {
      width: 100%; padding: 12px; border-radius: 8px; border: 1px solid #444;
      background: #1a1a1a; color: #fff; margin-bottom: 15px; font-size: .95rem;
      transition: border .3s ease, box-shadow .3s ease; box-sizing: border-box;
      font-family: "Segoe UI", Arial, sans-serif;
      height: var(--field-height); min-height: var(--field-height);
      line-height: 1.2;
    }
    select { height: var(--field-height); cursor: pointer; padding-top: 0; padding-bottom: 0; }
    textarea { min-height: 100px; height: auto; resize: vertical; line-height: 1.5; }

    input[type="text"]:focus, select:focus, textarea:focus {
      border-color: #ff6b9d; outline: none; box-shadow: 0 0 10px rgba(255,107,157,.3);
    }
    input[type="text"]::placeholder, textarea::placeholder { color: #888; }

    button {
      padding: 12px 18px; border: none; border-radius: 8px; font-size: .95rem; font-weight: 600;
      cursor: pointer; transition: transform .2s ease, background .25s ease, box-shadow .3s ease;
      height: var(--field-height);
    }
    button:hover:not(:disabled) { transform: translateY(-2px); }
    button:disabled { background: #555; color: #999; cursor: not-allowed; opacity: .6; }

    #issueCertBtn {
      background: linear-gradient(135deg, #00d4ff, #0096c7); color: #000; width: 100%;
      margin-top: 10px; height: 48px; font-size: 1.05rem;
    }
    #issueCertBtn:hover:not(:disabled) { background: linear-gradient(135deg,#00a8cc,#007a99); box-shadow: 0 4px 15px rgba(0,212,255,.4); }

    #revokeCertBtn { background: linear-gradient(135deg, #ff6b6b, #cc5555); color: #fff; }
    #revokeCertBtn:hover:not(:disabled) { background: linear-gradient(135deg,#ff5252,#b34343); box-shadow: 0 4px 15px rgba(255,107,107,.4); }

    #connectWallet { background: linear-gradient(135deg, #00ff88, #00d4ff); color: #000; }
    #connectWallet:hover { background: linear-gradient(135deg, #00cc6f, #00a8cc); box-shadow: 0 4px 15px rgba(0,255,136,.4); }

    #refreshAdminStatus { background: linear-gradient(135deg, #17a2b8, #138496); color: #fff; }
    #refreshAdminStatus:hover { background: linear-gradient(135deg,#138496,#10707f); box-shadow: 0 4px 15px rgba(23,162,184,.4); }

    .admin-btn { background: linear-gradient(135deg, #00d4ff, #0096c7); color:#000; }
    .admin-btn:hover:not(:disabled){ background: linear-gradient(135deg,#00a8cc,#007a99); box-shadow: 0 4px 15px rgba(0,212,255,.4); }

    .remove-btn { background: linear-gradient(135deg, #ff6b6b, #cc5555); color:#fff; }
    .remove-btn:hover:not(:disabled){ background: linear-gradient(135deg,#ff5252,#b34343); box-shadow: 0 4px 15px rgba(255,107,107,.4); }

    .check-btn { background: linear-gradient(135deg, #ffd700, #ffb300); color:#000; }
    .check-btn:hover:not(:disabled){ background: linear-gradient(135deg,#ffb300,#ff8c00); box-shadow: 0 4px 15px rgba(255,215,0,.4); }

    .status { margin: 15px 0; padding: 15px; border-radius: 8px; animation: fadeIn .5s ease; }
    .success { background: linear-gradient(135deg, #1a4d2e, #0f3a1f); color: #00ff88; border: 1px solid #00ff88; }
    .error   { background: linear-gradient(135deg, #4d1a1a, #3a0f0f); color: #ff6b6b; border: 1px solid #ff6b6b; }
    .info    { background: linear-gradient(135deg, #1a2d4d, #0f1f3a); color: #00d4ff; border: 1px solid #00d4ff; }
    .warning { background: linear-gradient(135deg, #4d3a1a, #3a2a0f); color: #ffd700; border: 1px solid #ffd700; }

    .loading { display: none; text-align: center; margin: 20px 0; }
    .spinner { border: 4px solid #333; border-top: 4px solid #ff6b9d; border-radius: 50%; width: 30px; height: 30px; animation: spin 1s linear infinite; margin: 0 auto 10px; }

    .form-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 15px; }
    .form-group { margin-bottom: 0; }
    .form-group-full { grid-column: 1 / -1; }

    .qr-display {
      margin-top: 20px; padding: 20px; background: linear-gradient(145deg, #2a2a3e, #1e1e2e);
      border-radius: 8px; border: 1px solid #00ff88; text-align: center; display: none;
    }
    .qr-display h3 { color: #00ff88; margin-top: 0; }
    #qrCodeCanvas { background: white; padding: 10px; border-radius: 8px; margin: 15px auto; display: inline-block; }
    .qr-actions { display: flex; gap: 10px; justify-content: center; margin-top: 15px; }
    .qr-actions button { flex: 0 1 auto; padding: 10px 20px; }

    .revoke-section { margin-top: 25px; padding: 20px; background: linear-gradient(145deg, #2a2535, #352f3a); border-radius: 8px; border: 1px solid #ff6b6b; }

    .admin-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-top: 20px; }
    .admin-card { background: linear-gradient(145deg, #2a2a3e, #1e1e2e); padding: 20px; border-radius: 8px; border: 1px solid #444; }
    .check-admin-group { display: flex; gap: 10px; align-items: flex-end; }
    .check-admin-group input { flex: 1; }

    @keyframes spin { to { transform: rotate(360deg); } }
    @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
    @keyframes fadeInUp { from { opacity: 0; transform: translateY(20px);} to { opacity: 1; transform: translateY(0);} }
    @keyframes slideIn { from { opacity: 0; transform: translateX(-20px);} to { opacity: 1; transform: translateX(0);} }

    .nav-links { margin-top: 20px; text-align: center; padding-top: 20px; border-top: 2px solid #333; }
    .nav-links p { color: #b0b0b0; margin-bottom: 10px; }
    .nav-links a {
      display: inline-block; padding: 10px 18px; margin: 5px; border-radius: 8px;
      background: linear-gradient(135deg, #00d4ff, #0096c7); color: #000; font-weight: 600; text-decoration: none;
      transition: transform .3s ease, background .25s ease, box-shadow .3s ease;
    }
    .nav-links a:hover { transform: translateY(-2px); background: linear-gradient(135deg, #00a8cc, #007a99); box-shadow: 0 4px 15px rgba(0,212,255,.4); }

    @media (max-width: 768px) {
      body { padding: 15px; } .container { padding: 20px; } h1 { font-size: 1.8rem; }
      .form-grid, .admin-grid { grid-template-columns: 1fr; }
      .check-admin-group { flex-direction: column; align-items: stretch; }
      .qr-actions { flex-direction: column; }
    }
  </style>
</head>

<body>
  <div class="container">
    <h1>Manufacturer Portal</h1>

    <div class="network-info" id="networkInfo">
      <strong>Network Status:</strong> Connecting to blockchain...
    </div>

    <div class="section">
      <h2>Wallet Connection</h2>
      <p class="muted"><strong>Connection required</strong> â€” Only authorized manufacturers can issue certificates.</p>

      <div id="connectionStatus" class="status warning">
        <strong>Wallet Not Connected</strong><br>
        Connect your MetaMask wallet to manage certificates
      </div>

      <div id="adminStatusControls" style="display:none; margin-top:10px;">
        <button id="refreshAdminStatus">Refresh My Authorization Status</button>
        <small style="display:block; margin-top:5px; color:#888;">Click to refresh your permissions if they have been changed</small>
      </div>

      <button id="connectWallet">Connect MetaMask</button>
    </div>

    <div id="manufacturerControls" style="display:none;">
      <!-- ISSUE CERTIFICATE -->
      <div class="section">
        <h2>Issue New Certificate</h2>
        <h3>Product Information</h3>

        <div class="form-grid">
          <div class="form-group">
            <label for="certificateId">Certificate ID *</label>
            <input type="text" id="certificateId" placeholder="Enter certificate ID">
          </div>

          <div class="form-group">
            <label for="productName">Product Name *</label>
            <input type="text" id="productName" placeholder="Enter product name">
          </div>

          <div class="form-group">
            <label for="mfgName">Manufacturer Name *</label>
            <input type="text" id="mfgName" placeholder="Enter manufacturer name">
          </div>

          <div class="form-group">
            <label for="mfgDate">Date of Manufacture *</label>
            <input type="text" id="mfgDate" placeholder="Select date">
          </div>

          <div class="form-group">
            <label for="expDate">Date of Expiry <span class="muted">(optional)</span></label>
            <input type="text" id="expDate" placeholder="Select date">
          </div>

          <div class="form-group">
            <label for="location">Manufacturing Location <span class="muted">(optional)</span></label>
            <select id="location">
              <option value="">Select country...</option>
            </select>
          </div>

          <div class="form-group">
            <label for="intendedRegion">Intended Region of Sale <span class="muted">(optional)</span></label>
            <select id="intendedRegion">
              <option value="">Select region...</option>
              <option value="Global">Global</option>
              <option value="North America">North America</option>
              <option value="South America">South America</option>
              <option value="Europe">Europe</option>
              <option value="Asia">Asia</option>
              <option value="Africa">Africa</option>
              <option value="Oceania">Oceania</option>
              <option value="Middle East">Middle East</option>
            </select>
          </div>

          <div class="form-group form-group-full">
            <label for="details">Product Details <span class="muted">(optional, stored on-chain)</span></label>
            <textarea id="details" placeholder="Enter product specs, batch number, etc."></textarea>
          </div>

          <div class="form-group form-group-full">
            <label for="notes">Additional Notes <span class="muted">(optional, stored on-chain)</span></label>
            <textarea id="notes" placeholder="Any additional information..."></textarea>
          </div>
        </div>

        <button id="issueCertBtn" disabled>Issue Certificate &amp; Generate QR Code</button>

        <div class="qr-display" id="qrDisplay" style="display:none">
          <h3>Certificate Created Successfully!</h3>
          <p><strong>Certificate ID:</strong> <span id="generatedCertId"></span></p>
          <canvas id="qrCodeCanvas" width="300" height="300"></canvas>
          <img id="qrImgFallback" alt="QR Code" style="display:none;width:300px;height:300px" />
          <p class="muted" style="margin:10px 0;">Scan this QR code to verify the certificate</p>
          <div class="qr-actions">
            <button onclick="downloadQR()">Download QR Code</button>
            <button onclick="printQR()">Print QR Code</button>
          </div>
        </div>

        <div class="loading" id="issueLoading">
          <div class="spinner"></div>
          <p>Processing transaction...</p>
        </div>

        <div class="revoke-section">
          <h4>Revoke Certificate</h4>
          <p class="muted">Enter certificate ID to revoke an existing certificate</p>
          <div style="display:flex; gap:10px; align-items:flex-start;">
            <input type="text" id="revokeCertId" placeholder="Certificate ID to revoke" style="flex:1; margin-bottom:0;">
            <button id="revokeCertBtn" style="flex:0 0 auto; width:auto;">Revoke Certificate</button>
          </div>
          
          <h4 style="margin-top: 20px;">Batch Certificate Revocation</h4>
          <p class="muted">Revoke multiple certificates at once by entering certificate IDs separated by commas or new lines</p>
          <textarea id="batchRevokeCertIds" placeholder="Enter certificate IDs separated by commas or new lines" style="width: 100%; margin-bottom: 10px; min-height: 80px;"></textarea>
          <div style="display:flex; gap:10px; align-items:flex-start;">
            <select id="batchRevokeParams" style="flex:1; margin-bottom:0;">
              <option value="all">All Certificates</option>
              <option value="expired">Expired Certificates Only</option>
              <option value="region">By Region</option>
              <option value="location">By Location</option>
            </select>
            <input type="text" id="batchRevokeParamValue" placeholder="Parameter value (for region/location)" style="flex:2; margin-bottom:0; display:none; height: var(--field-height);">
            <button id="batchRevokeCertBtn" class="remove-btn" style="flex:0 0 auto; width:auto;">Revoke Batch</button>
          </div>
          <div id="batchRevokeStatus" class="status info" style="margin-top: 10px; display: none;"></div>
        </div>
      </div>

      <!-- UPDATE METADATA -->
      <div class="section">
        <h2>Update Certificate Metadata</h2>
        <p class="muted">Only the current certificate owner or an admin can update these fields.</p>

        <div class="form-grid">
          <div class="form-group">
            <label for="metaCertId">Certificate ID *</label>
            <input type="text" id="metaCertId" placeholder="Enter certificate ID">
          </div>

          <div class="form-group">
            <label for="metaExpDate">New Expiry <span class="muted">(optional)</span></label>
            <input type="text" id="metaExpDate" placeholder="Select date">
          </div>

          <div class="form-group">
            <label for="metaLocation">New Location <span class="muted">(optional)</span></label>
            <input type="text" id="metaLocation" placeholder="e.g., Germany">
          </div>

          <div class="form-group">
            <label for="metaRegion">New Intended Region <span class="muted">(optional)</span></label>
            <input type="text" id="metaRegion" placeholder="e.g., Europe">
          </div>

          <div class="form-group form-group-full">
            <label for="metaDetails">New Details <span class="muted">(optional)</span></label>
            <textarea id="metaDetails" placeholder="Leave blank to keep unchanged"></textarea>
          </div>

          <div class="form-group form-group-full">
            <label for="metaNotes">New Notes <span class="muted">(optional)</span></label>
            <textarea id="metaNotes" placeholder="Leave blank to keep unchanged"></textarea>
          </div>
        </div>

        <div style="display:flex; gap:10px; align-items:flex-start;">
          <button id="updateMetaBtn" class="admin-btn" style="flex:0 0 auto;">Update Metadata</button>
          <div id="metaStatus" class="status info" style="flex:1;">Fill any field(s) to update, then click Update.</div>
        </div>

        <div class="loading" id="metaLoading">
          <div class="spinner"></div>
          <p>Submitting metadata update...</p>
        </div>
      </div>

      <!-- ADMIN MANAGEMENT -->
      <div class="section">
        <h2>Admin Management</h2>
        <p class="muted"><strong>Owner Only</strong> â€” Manage manufacturer accounts</p>

        <div id="adminList" class="info status">Loading admin information...</div>

        <div class="admin-grid">
          <div class="admin-card">
            <h3>Add New Manufacturer</h3>
            <input type="text" id="newAdminAddress" placeholder="Enter wallet address (0x...)">
            <button id="addAdminBtn" class="admin-btn">Add Manufacturer</button>
          </div>

          <div class="admin-card">
            <h3>Remove Manufacturer</h3>
            <input type="text" id="removeAdminAddress" placeholder="Enter wallet address (0x...)">
            <button id="removeAdminBtn" class="remove-btn">Remove Manufacturer</button>
          </div>
        </div>

        <div class="admin-card" style="margin-top:20px;">
          <h3>Check Authorization Status</h3>
          <div class="check-admin-group">
            <input type="text" id="checkAdminAddress" placeholder="Enter address to check (0x...)">
            <button id="checkAdminBtn" class="check-btn">Check Status</button>
          </div>
          <div id="adminCheckResult" style="margin-top:10px;"></div>
        </div>

        <div class="loading" id="adminLoading">
          <div class="spinner"></div>
          <p>Processing admin operation...</p>
        </div>
      </div>
    </div>


  </div>

  <!-- JS includes at the bottom -->
  <script src="https://cdn.jsdelivr.net/npm/ethers@5.7.2/dist/ethers.umd.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
  <script src="app.js?v=1.1"></script>
  
  <div class="nav-container" style="margin-top: 30px; border-top: 1px solid #333; padding-top: 20px;">
    <a href="index.html" class="nav-button">Certificate Verification</a>
    <a href="distributor.html" class="nav-button">Distributor/Consumer Portal</a>
    <a href="analytics.html" class="nav-button">Analytics Dashboard</a>
  </div>

  <script>
    // ---------- UX: date pickers ----------
    document.addEventListener('DOMContentLoaded', function () {
      try {
        if (typeof flatpickr !== 'undefined') {
          const mfg = document.getElementById('mfgDate');
          const exp = document.getElementById('expDate');
          const metaExp = document.getElementById('metaExpDate');

          if (mfg) {
            flatpickr(mfg, {
              dateFormat: 'Y-m-d',
              altInput: true, altFormat: 'd M Y',
              allowInput: true, // allow past dates
              appendTo: document.body,
              onChange: function(selectedDates) {
                if (exp && exp._flatpickr) {
                  // set exp minDate to selected mfgDate + 1 day
                  const d = selectedDates?.[0];
                  if (d) {
                    const min = new Date(d.getTime() + 24*60*60*1000);
                    exp._flatpickr.set('minDate', min);
                  } else {
                    exp._flatpickr.set('minDate', null);
                  }
                }
              }
            });
          }

          if (exp) {
            flatpickr(exp, {
              dateFormat: 'Y-m-d',
              altInput: true, altFormat: 'd M Y',
              allowInput: true,
              appendTo: document.body
            });
          }

          if (metaExp) {
            flatpickr(metaExp, {
              dateFormat: 'Y-m-d',
              altInput: true, altFormat: 'd M Y',
              allowInput: true,
              appendTo: document.body
            });
          }
        }
      } catch (e) { console.warn('Flatpickr init error:', e); }

      // Countries for location select (optional)
      const countries = ["Afghanistan","Albania","Algeria","Andorra","Angola","Argentina","Armenia","Australia","Austria","Azerbaijan","Bahamas","Bahrain","Bangladesh","Barbados","Belarus","Belgium","Belize","Benin","Bhutan","Bolivia","Bosnia and Herzegovina","Botswana","Brazil","Brunei","Bulgaria","Burkina Faso","Burundi","Cambodia","Cameroon","Canada","Cape Verde","Central African Republic","Chad","Chile","China","Colombia","Comoros","Congo","Costa Rica","Croatia","Cuba","Cyprus","Czech Republic","Denmark","Djibouti","Dominica","Dominican Republic","Ecuador","Egypt","El Salvador","Equatorial Guinea","Eritrea","Estonia","Ethiopia","Fiji","Finland","France","Gabon","Gambia","Georgia","Germany","Ghana","Greece","Grenada","Guatemala","Guinea","Guinea-Bissau","Guyana","Haiti","Honduras","Hungary","Iceland","India","Indonesia","Iran","Iraq","Ireland","Israel","Italy","Jamaica","Japan","Jordan","Kazakhstan","Kenya","Kiribati","Kuwait","Kyrgyzstan","Laos","Latvia","Lebanon","Lesotho","Liberia","Libya","Liechtenstein","Lithuania","Luxembourg","Madagascar","Malawi","Malaysia","Maldives","Mali","Malta","Marshall Islands","Mauritania","Mauritius","Mexico","Micronesia","Moldova","Monaco","Mongolia","Montenegro","Morocco","Mozambique","Myanmar","Namibia","Nauru","Nepal","Netherlands","New Zealand","Nicaragua","Niger","Nigeria","North Korea","North Macedonia","Norway","Oman","Pakistan","Palau","Palestine","Panama","Papua New Guinea","Paraguay","Peru","Philippines","Poland","Portugal","Qatar","Romania","Russia","Rwanda","Saint Kitts and Nevis","Saint Lucia","Saint Vincent and the Grenadines","Samoa","San Marino","Sao Tome and Principe","Saudi Arabia","Senegal","Serbia","Seychelles","Sierra Leone","Singapore","Slovakia","Slovenia","Solomon Islands","Somalia","South Africa","South Korea","South Sudan","Spain","Sri Lanka","Sudan","Suriname","Sweden","Switzerland","Syria","Taiwan","Tajikistan","Tanzania","Thailand","Timor-Leste","Togo","Tonga","Trinidad and Tobago","Tunisia","Turkey","Turkmenistan","Tuvalu","Uganda","Ukraine","United Arab Emirates","United Kingdom","United States","Uruguay","Uzbekistan","Vanuatu","Vatican City","Venezuela","Vietnam","Yemen","Zambia","Zimbabwe"];
      const locationSelect = document.getElementById('location');
      if (locationSelect) {
        countries.forEach(country => {
          const option = document.createElement('option');
          option.value = country; option.textContent = country;
          locationSelect.appendChild(option);
        });
      }
    });

    // ---------- Metadata Updater (uses functions from app.js) ----------
    (function () {
      const btn = document.getElementById('updateMetaBtn');
      if (!btn) return;

      btn.addEventListener('click', async function () {
        const certId = (document.getElementById('metaCertId')?.value || '').trim();
        const expStr = (document.getElementById('metaExpDate')?.value || '').trim();
        const loc    = (document.getElementById('metaLocation')?.value || '').trim();
        const reg    = (document.getElementById('metaRegion')?.value || '').trim();
        const det    = (document.getElementById('metaDetails')?.value || '').trim();
        const note   = (document.getElementById('metaNotes')?.value || '').trim();
        const target = 'metaStatus';

        if (!certId) {
          showStatus(target, 'Enter a certificate ID.', 'error');
          return;
        }
        if (!window.walletContract || !window.userAccount) {
          showStatus(target, 'Please connect your wallet first.', 'error');
          return;
        }

        // At least one field should be provided
        if (!expStr && !loc && !reg && !det && !note) {
          showStatus(target, 'Fill at least one field to update.', 'warning');
          return;
        }

        // Convert expiry (0 keeps unchanged)
        let expTs = 0;
        if (expStr) {
          const t = Math.floor(new Date(expStr).getTime() / 1000);
          if (!Number.isFinite(t) || t <= 0) {
            showStatus(target, 'Invalid expiry date.', 'error'); return;
          }
          expTs = t;
        }

        try {
          showLoading('metaLoading', true);
          showStatus(target, 'Submitting metadata updateâ€¦', 'info');
          const tx = await window.walletContract.updateCertificateMetadata(
            certId, expTs, loc, reg, det, note
          );
          const rcpt = await tx.wait();
          showStatus(
            target,
            `Metadata updated.<br>TX: <a target="_blank" rel="noopener" href="https://sepolia.etherscan.io/tx/${rcpt.transactionHash}">${rcpt.transactionHash.slice(0,10)}â€¦</a>`,
            'success'
          );

          // Optional: clear inputs after success
          ['metaExpDate','metaLocation','metaRegion','metaDetails','metaNotes'].forEach(id => {
            const el = document.getElementById(id); if (el) el.value = '';
          });
        } catch (err) {
          let msg = err?.reason || err?.message || 'Unknown error';
          if (/user rejected/i.test(msg)) msg = 'Transaction rejected by user';
          showStatus(target, 'Failed to update: ' + msg, 'error');
        } finally {
          showLoading('metaLoading', false);
        }
      });
    })();
  </script>
</body>
</html>
